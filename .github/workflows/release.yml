name: Create Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: "Routine Flow"
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" $PREVIOUS_TAG..HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s")
          fi

          FEATURES=$(echo "$COMMITS" | grep -E "^feat(\([^)]*\))?:" | sed 's/^feat[^:]*: /‚ú® /' || true)
          FIXES=$(echo "$COMMITS" | grep -E "^fix(\([^)]*\))?:" | sed 's/^fix[^:]*: /üêõ /' || true)
          STYLES=$(echo "$COMMITS" | grep -E "^style(\([^)]*\))?:" | sed 's/^style[^:]*: /üé® /' || true)
          DOCS=$(echo "$COMMITS" | grep -E "^docs(\([^)]*\))?:" | sed 's/^docs[^:]*: /üìö /' || true)
          OTHERS=$(echo "$COMMITS" | grep -vE "^(feat|fix|style|docs)(\([^)]*\))?:" | sed 's/^/‚ö° /' || true)

          cat << EOF > release_notes.md
          ## [APP] ${PROJECT_NAME} - ${{ github.ref_name }}

          ### [INSTALL] How to Install
          1. Download the XML file attached below
          2. Open Tasker
          3. Long click on any existing project
          4. Select "Import Project" from the menu that appears
          5. Select the downloaded XML file

          ### [CHANGELOG] Changelog
          EOF

          if [ -n "$FEATURES" ]; then
            echo "#### ‚ú® New Features" >> release_notes.md
            echo "$FEATURES" >> release_notes.md
            echo "" >> release_notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "#### üêõ Bug Fixes" >> release_notes.md
            echo "$FIXES" >> release_notes.md
            echo "" >> release_notes.md
          fi

          if [ -n "$STYLES" ]; then
            echo "#### üé® UI Improvements" >> release_notes.md
            echo "$STYLES" >> release_notes.md
            echo "" >> release_notes.md
          fi

          if [ -n "$DOCS" ]; then
            echo "#### üìö Documentation" >> release_notes.md
            echo "$DOCS" >> release_notes.md
            echo "" >> release_notes.md
          fi

          if [ -n "$OTHERS" ]; then
            echo "#### ‚ö° Other Changes" >> release_notes.md
            echo "$OTHERS" >> release_notes.md
            echo "" >> release_notes.md
          fi

          cat << EOF >> release_notes.md

          ### üí° Note
          This release includes both the Tasker project XML and the web code needed for the project's webview.

          EOF

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${PROJECT_NAME} Project ${{ github.ref_name }}" \
            --notes-file release_notes.md

          # Find only the first XML file
          xml_file=$(find . -name "*.xml" -type f | head -1)

          if [ -n "$xml_file" ]; then
            if gh release upload "${{ github.ref_name }}" "$xml_file" --clobber; then
              echo "[SUCCESS] Upload completed: $xml_file"
            else
              echo "[ERROR] Upload error: $xml_file"
              exit 1
            fi
          else
            echo "[WARNING] No XML file found for upload"
            exit 1
          fi